<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:p="http://primefaces.org/ui">
<h:head>
    <title>Тест БД</title>
    <h:outputScript library="js" name="coords.js" target="body" />
    <h:outputScript library="js" name="timeline.js" target="body" />

    <style>
        .coords-form {
            text-align: left;
        }

        .coord-box {
            border: 1px solid #888;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 12px;
            width: 350px;
            background: #f7f7f7;
        }

        .coord-label {
            font-weight: bold;
            margin-bottom: 6px;
            display: block;
        }

        .result-row {
            opacity: 1;
            transform: translateY(0);
        }

        .result-row-new {
            opacity: 0;
            transform: translateY(-5px);
            animation: fadeInRow 0.4s ease-out forwards;
        }

        @keyframes fadeInRow {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</h:head>
<h:body>
    <header>
        <h1>Поляков Алексей Леонидович</h1>
        <h2>P3209</h2>
        <h3>Вариант 9812</h3>
    </header>
    <canvas id="graph" width="400" height="400"></canvas>
    <br />
    <h:form id="coordsForm">
        <h3>Ввод координат</h3>
        <div class="coord-box">
            <span class="coord-label">X:</span>
            <h:selectOneMenu value="#{coordBean.x}">
                <f:selectItems value="#{coordBean.possibleX}" />
            </h:selectOneMenu>
        </div>

        <div class="coord-box">
            <span class="coord-label">Y:</span>
            <h:inputText id="valueY" value="#{coordBean.y}" />
            <div id="msg" style="color:red;"></div>
        </div>

        <div class="coord-box">
            <span class="coord-label">R:</span>
            <h:inputText id="valueR" value="#{coordBean.r}" />
            <div id="msgR" style="color:red;"></div>
        </div>

        <h:commandButton id="userBtn" value="Проверить и сохранить" action="#{coordBean.process}">
            <f:ajax execute="@form" render="pointsJson resultsPanel" onevent="onPointsUpdated" />
        </h:commandButton>

        <h:outputText id="pointsJson" value="#{dataBaseBean.pointsJson}" style="display:none" escape="false" />
        <h:messages />

        <h:panelGroup id="resultsPanel" rendered="#{not empty dataBaseBean.results}">

            <h3>Сохранённые результаты</h3>

            <h:dataTable value="#{dataBaseBean.results}" var="res" border="1" rowClasses="result-row">

                <h:column>
                    <f:facet name="header">X</f:facet>
                    #{res.x}
                </h:column>
                <h:column>
                    <f:facet name="header">Y</f:facet>
                    #{res.y}
                </h:column>
                <h:column>
                    <f:facet name="header">R</f:facet>
                    #{res.r}
                </h:column>
                <h:column>
                    <f:facet name="header">Hit</f:facet>
                    #{res.hit ? 'да' : 'нет'}
                </h:column>
                <h:column>
                    <f:facet name="header">Время</f:facet>
                    #{res.createdAt}
                </h:column>
            </h:dataTable>
        </h:panelGroup>
    </h:form>


    <h:form id="FormForJS" style="display:none">
        <h:inputText id="FieldX" value="#{coordBean.x}" />
        <h:inputText id="FieldY" value="#{coordBean.y}" />
        <h:inputText id="FieldR" value="#{coordBean.r}" />
        <h:commandButton id="submitBtn" action="#{coordBean.process}">
            <f:ajax execute="@form" render=":coordsForm:pointsJson :coordsForm:resultsPanel"
                onevent="onPointsUpdated" />
        </h:commandButton>
    </h:form>

    <h:form>
        <h:commandButton value="Перейти на начальную страницу" action="goToStart" />
    </h:form>

    <h:form id="form">

        <p:timeline id="timeline" value="#{timelineBean.model}" var="item" height="750px">

            <div style="text-align:center; margin:4px;">
                <canvas id="canvas_#{item.id}" width="200" height="200" style="border:1px solid #444;"></canvas>

                <div style="font-size:12px; color:#555;">
                    #{item.startTime} – #{item.endTime} <br/>
                    R=#{item.r}
                </div>
            </div>
        </p:timeline>

        <h:outputText id="timelineJson" value="#{timelineBean.toJsonArray()}" style="display:none" escape="false" />
        <div id="forjson"></div>


    </h:form>

    <h:outputScript>
        function onPointsUpdated(data) {
        if (data.status === 'success') {
        Loadpoints();
        drawGraph();

        const table = document.querySelector('#coordsForm\\:resultsPanel table');
        if (table) {
        const rows = table.querySelectorAll('tr');
        if (rows.length > 1) {
        const firstDataRow = rows[1];
        firstDataRow.classList.remove('result-row-new');
        void firstDataRow.offsetWidth;
        firstDataRow.classList.add('result-row-new');
        }
        }
        }
        }
    </h:outputScript>


</h:body>

</html>